<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">

<!--link rel="import" href="../bower_components/paper-input-container/paper-input-container.html"-->
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="ap-icons.html">
<link rel="import" href="ap-login.html">
<link rel="import" href="nlp-draft-myprofile.html">
<link rel="import" href="ap-home.html">
<link rel="import" href="ap-resources.html">
<link rel="import" href="ap-clients.html">
<link rel="import" href="ap-attorneys.html">

<script type="module" src="nlp-draft-api.js">
</script>

<dom-module id="ap-app">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-factors"></style>
        <style include="shared-styles">

            :host {
                --color-green-old: #01aa50;
                --color-green: #48b519; /*#56c626;*/
                --color-blue: #5bc9dd;
                --app-primary-color: var(--color-green);
                /*--app-primary-color: #56c626;*/
                --app-secondary-color: black;
                display: block;
                /* this should only apply if app drawer subdrawer is visible */
                --app-drawer-width: 256px;
                min-height: 100vh;
            }

            iron-pages {
                background: #eee;
                min-height: calc(100vh - 64px);
            }

            .drawer-primary {
                width: var(--app-drawer-width);
            }

            .drawer-list > a iron-icon {
                vertical-align: -12%;
            }

            app-header-layout {
                position: static; /* this fixes iron-pages visibility, fix this */
                /*min-height:calc(100vh - 64px);*/
            }

            app-drawer-layout {
                /*margin-top:64px;*/
            }

                app-drawer-layout:not([narrow]) [drawer-toggle] {
                    display: none;
                }

            app-header {
                background: #fff;
                box-shadow: 0 0 10px rgba(0,0,0,0.75);
            }


            .logo-header {
                width: 160px;
                vertical-align: middle;
            }

            .bg-primary {
                background: var(--app-primary-color);
            }

            .drawer-primary app-toolbar {
                background: #414141;
                height: auto;
                padding-top: 16px;
                padding-bottom: 16px;
            }

            .drawer-content {
                margin-top: 64px;
                height: calc(100% - 64px);
                overflow: auto;
            }

            /* drawer - primary */
            .drawer-primary {
                background: var(--app-primary-color);
                color: #fff;
            }

                .drawer-primary a,
                .drawer-primary a.iron-selected {
                    color: #fff;
                }

            /* drawer - secondary */
            .user-logged-in {
                font-size: 15px;
                width: 100%;
                position: relative;
            }

            .recently-viewed ul, .recently-viewed iron-selector {
                list-style: none;
                padding: 0 0 0 30px;
                margin: 0;
                font-size: 12px;
            }

                .recently-viewed ul a, .recently-viewed iron-selector a {
                    line-height: 2.5;
                    opacity: 0.75;
                    transition: opacity 300ms ease;
                }

                    .recently-viewed ul a:hover, .recently-viewed iron-selector a:hover {
                        opacity: 1;
                    }

            .recently-viewed iron-icon {
                width: 16px;
                height: 16px;
                margin-right: 4px;
            }

            .bell {
                color: #414141;
                cursor: pointer;
            }
        </style>

        <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
        <app-route route="[[route]]" pattern="/:id" data="{{routeData}}" tail="{{subroute}}"></app-route>

        <template is="dom-if" if="[[!loggedIn]]">
            <ap-login on-logged-in="onLoggedIn"></ap-login>
        </template>

        <template is="dom-if" if="[[loggedIn]]">
            <app-header-layout has-scrolling-region>
                <app-header slot="header" condenses xreveals effects="waterfall" fixed>
                    <app-toolbar>
                        <!--paper-icon-button icon="ap-icons:menu" drawer-toggle></paper-icon-button-->
                        <div class="main-title"><a href="[[rootPath]]"><img class="logo-header" src="/images/logo-netlaw.png" alt="NetLaw"></a></div>

                        <paper-input label="Search" no-label-float class="search">
                            <iron-icon icon="ap-icons:search" slot="prefix"></iron-icon>
                            <paper-icon-button slot="suffix" onclick="clearInput()" icon="ap-icons:clear" alt="clear" title="clear" class="clear">
                            </paper-icon-button>
                        </paper-input>
                        <iron-icon class="flex-item-right bell" icon="ap-icons:bell"></iron-icon>
                    </app-toolbar>
                </app-header>
                <app-drawer-layout xfullbleed narrow="{{narrow}}">
                    <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
                        <div class="layout horizontal drawer-content">
                            <div class="drawer-primary">
                                <app-toolbar>
                                    <div class="user-logged-in">
                                        <img class="avatar" src="/images/profile-pictures/user-profile-50x50.jpg" alt="">
                                        <div class="welcome">
                                            <paper-menu-button class="user-menu" horizontal-offset="-16" vertical-offset="30" open-animation-config="{{openAnimationConfig}}">
                                                <span class="user-menu-trigger" slot="dropdown-trigger">Welcome back, <b>Kyle</b><iron-icon icon="ap-icons:arrow-drop-down" class="user-menu-icon"></iron-icon></span>
                                                <iron-selector class="user-menu-content" slot="dropdown-content" style="display:block;width:256px;">
                                                    <a href="[[rootPath]]myprofile" class$="{{isSubpathSelected(route.path, 'myprofile', 1)}}">My Profile</a>
                                                    <a>My Account</a>
                                                    <a>Support</a>
                                                    <!--hr /-->
                                                    <a class="logout" href="javascript:;" on-click="onSignOutClick">Sign out</a>
                                                </iron-selector>
                                            </paper-menu-button>
                                        </div>
                                    </div>
                                </app-toolbar>
                                <iron-selector class="drawer-list" role="navigation">
                                    <a name="clients" href="[[rootPath]]clients" class$="{{isSubpathSelected(route.path, 'clients', 1)}}"><iron-icon icon="ap-icons:people" slot="item-icon"></iron-icon> Clients</a>
                                    <a name="attorneys" href="[[rootPath]]attorneys" class$="{{isSubpathSelected(route.path, 'attorneys', 1)}}"><iron-icon icon="ap-icons:work" slot="item-icon"></iron-icon> My Firm</a>
                                    <a name="resources" href="[[rootPath]]resources" class$="{{isSubpathSelected(route.path, 'resources', 1)}}"><iron-icon icon="ap-icons:dashboard" slot="item-icon"></iron-icon> Resources</a>
                                    <hr>
                                    <div class="recently-viewed">
                                        <a href="javascript:;"><iron-icon icon="ap-icons:star" slot="item-icon"></iron-icon> Recently Viewed</a>
                                        <ul>
                                            <template is="dom-repeat" items="[[recents]]">
                                                <li><a href="{{item.href}}" class$="{{isSubpathSelected(route.path, item.href, 2)}}"><iron-icon icon="ap-icons:{{typeToIcon(item.type)}}" slot="item-icon"></iron-icon> {{item.text}}</a></li>
                                            </template>
                                        </ul>
                                    </div>
                                </iron-selector>
                            </div>
                        </div>
                    </app-drawer>

                    <iron-pages class="main-content" selected="[[active]]" attr-for-selected="name" role="main" fallback-selection="home">
                        <nlp-draft-myprofile name="myprofile"></nlp-draft-myprofile>
                        <ap-home name="home"></ap-home>
                        <ap-resources name="resources"></ap-resources>
                        <ap-clients name="clients" route="[[subroute]]"></ap-clients>
                        <ap-attorneys name="attorneys" route="[[subroute]]"></ap-attorneys>
                    </iron-pages>
                </app-drawer-layout>
            </app-header-layout>

        </template>
    </template>
    <script>
        // Gesture events like tap and track generated from touch will not be
        // preventable, allowing for better scrolling performance.
        Polymer.setPassiveTouchGestures(true);

        class ApApp extends Polymer.Element {
            static get is() { return 'ap-app'; }

            static get properties() {
                return {
                    loggedIn: { type: Boolean, value: () => location.pathname !== "/" },

                    rootPath: String,
                    route: { type: Object },
                    routeData: { type: Object, observer: '_routeDataObserver' },
                    subroute: Object,

                    active: String,

                    recents: {
                        value: () => [
                            { type: "client", href: "clients/4c890c89-2cf9-4611-b754-1bd196c1f0ab", text: "Tim Cain" },
                            { type: "client", href: "clients/e28ed224-17e4-40c7-9abf-d2927aa46d0b/vault", text: "Herbie Hancock" },
                            { type: "attorney", href: "attorneys/21c6537b-2e84-45c9-b9be-7f338f19c309", text: "Rory Gallagher" },
                            { type: "attorney", href: "attorneys/2874b8a9-f498-4027-b524-5a0da0dc8d88", text: "Dave Mustaine" },
                            { type: "attorney", href: "attorneys/f022555b-aeb2-418d-a405-cfbf21b481ba", text: "Jaco Postorius" },
                        ],
                    },
                    openAnimationConfig: {
                        type: Object,
                        value: function () {
                            return [
                                { name: 'fade-in-animation', timing: { delay: 100, duration: 200 } },
                                {
                                    name: 'paper-menu-grow-height-animation',
                                    timing: {
                                        delay: 100,
                                        duration: 275,
                                        easing: 'cubic-bezier(.3,.95,.5,1)'
                                    }
                                }
                            ];
                        }
                    },
                };
            }

            constructor() {
                super();
                window.navigate = path => {
                    window.history.pushState({}, null, `${this.rootPath}${path || ""}`);
                    window.dispatchEvent(new CustomEvent('location-changed'));
                };
            }


            onLoggedIn(e) {
                this.loggedIn = true;
            }

            onSignOutClick(e) {
                this.loggedIn = false;
            }

            _routeDataObserver(value) { this.active = value.id || null; }

            typeToIcon(type) {
                switch (type) {
                    case "client": return "people";
                    case "attorney": return "work";
                    default: return "";
                }
            }

            isSubpathSelected(path, subpath, levels) { return this.isSubpath(path, subpath, levels) ? "iron-selected" : null; }

            isSubpath(path, subpath, levels) {
                if (!path || !subpath) return null;
                let paths = (path[0] === "/" ? path.substr(1) : paths).split("/");
                let subpaths = (subpath[0] === "/" ? subpath.substr(1) : subpath).split("/");
                for (let i = 0; i < subpaths.length; i++) {
                    if (i >= levels) return true;
                    if (paths[i] != subpaths[i]) return false;
                }
                return true;
            }

            isEqual(first, second) { return first === second; }
            isTrue(value) { return !!value; }
            isFalse(value) { return !value; }

        }

        window.customElements.define(ApApp.is, ApApp);
    </script>
</dom-module>
