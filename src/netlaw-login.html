<!-- Load the Polymer.Element base class -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-password-input/paper-password-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="netlaw-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="netlaw-login">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style is="custom-style" include="iron-flex iron-flex-factors"></style>
    <style include="shared-styles">
      :host {
        --iron-icon-fill-color: #ffffff;
      }

      /*.login__container.netlaw-login {*/
      .login__container {
        background-image: url("../images/Login_BG.png");
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center;
        height: 75vh;
      }

      .login-buttons {
        max-width: 285px;
        margin: 80px auto 0;
        display: flex;
        justify-content: center;
      }

      .login-buttons paper-icon-button {
        width: 25%;
        height: 45px;
      }

      .login-buttons paper-icon-button:first-child {
        border-top-left-radius: 2px;
        border-bottom-left-radius: 2px;
      }

      .login-buttons paper-icon-button:last-child {
        border-top-right-radius: 2px;
        border-bottom-right-radius: 2px;
      }

      .login-buttons paper-icon-button[name="googleplus"] {
        background: #FF3624;
      }

      .login-buttons paper-icon-button[name="facebook"] {
        background: #024DAF;
      }

      .login-buttons paper-icon-button[name="linkedin"] {
        background: #0178BD;
      }

      .login-buttons paper-icon-button[name="twitter"] {
        background: #01B8EC;
      }

      .login__item-desc {
        min-height: 75px;
      }

      @media (min-width: 320px) and (max-width: 767px) {
        .login-buttons {
          margin-top: 45px;
        }

        .navbar--login {
          height: 50px;
        }
        .login__item-desc {
          min-height: fit-content;
        }
        .login__row.login__margin-top-big  hr {
          display: none;
        }
      }

    </style>

    <!--<app-route route="{{route}}" pattern="/:id" data="{{routeData}}" tail="{{subroute}}"></app-route>-->
    <app-header-layout fullbleed="" narrow="{{narrow}}">
      <app-header  slot="header" condenses="" reveals="" effects="waterfall">
        <app-toolbar class="navbar navbar--login">
          <netlaw-logo></netlaw-logo>
        </app-toolbar>
      </app-header>

      <div class="login__main login__section login__position-relative">
        <div class="login__container ">

          <div id="wrapper" class="login__align-center login">

            <template is="dom-if" if="[[firstScreen]]">
              <h1>Login to your Account</h1>

              <div class="login-buttons">
                <paper-icon-button icon="netlaw-icons:login-googleplus" name="googleplus"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-facebook" name="facebook"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-linkedin" name="linkedin"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-twitter" name="twitter"
                                   on-click="onLoginClick"></paper-icon-button>
              </div>
              <div class="login__divider-icon">OR</div>

              <div class="login__margin login__align-center">
                <form action="javascript:;" method="post" class="login-form login__align-center" novalidate>
                  <div class="login__margin ">
                    <label for="login-name"></label>
                    <input type="text" class="login__input" id="login-name" name="login" placeholder="Username*"
                           required autofocus autocomplete="username" value="{{identifier}}" invalid$="{{error}}" error-message="{{error}}" on-keydown="" disabled="[[loading]]">
                  </div>
                  <div class="login__margin">
                    <label for="login-pass"></label>
                    <input type="password" class="login__input" id="login-pass" name="pass" placeholder="Password*"
                           required>
                  </div>
                  <div class="login__margin-top">
                    <a href="javascript:;" on-click="onForgotClick">Forgot Your Password?</a>
                  </div>
                  <hr class="login__divider-small">
                  <div class="login__margin-bottom">
                    <button class="btn btn-primary" on-click="onLoginClick" >Login</button>
                  </div>
                </form>
              </div>
              <p class="login__margin">Donâ€™t have an account? <a href="javascript:;" on-click="onCreateAccount">Request
                One</a>
              </p>
            </template>


            <template is="dom-if" if="[[createAccountScreen]]">
              <div name="create-account" xwide login>
                <h1>Create your NetLaw Account</h1>
                <p>to continue to NetDraft</p>

                <paper-input class="flex-6" label="Your name" name="name" autocomplete="name" autofocus
                             disabled="[[loading]]" value="{{name}}"></paper-input>
                <paper-input class="flex-6" label="Your email address" name="email" autocomplete="email"
                             disabled="[[loading]]" value="{{email}}"></paper-input>
                <paper-password-input class="flex-6" label="Enter your password" name="password"
                                      autocomplete="current-password" disabled="[[loading]]"
                                      value="{{password}}"></paper-password-input>
                <paper-input label="Your phone (optional)" name="phone" autocomplete="phone" disabled="[[loading]]"
                             value="{{phone}}"></paper-input>

                <div class="margin-top-32px">
                  <paper-checkbox checked="{{agreesWithTerms}}">I acknowledge and agree to <strong>Terms of Use</strong>
                    for this site
                  </paper-checkbox>
                </div>

                <div class="layout horizontal margin-top-16px">
                  <div class="flex-8">
                    <paper-button class="flat" name="signin" disabled="[[loading]]" on-click="onNavigate">Sign in
                      instead
                    </paper-button>
                  </div>
                  <div class="flex-4 text-right">
                    <paper-button class="primary" disabled="[[!canCreateAccount]]" on-click="onCreateAccount">Next
                    </paper-button>
                  </div>
                  <div class="login__margin">
                    <button class="btn btn-cancel" on-click="onCancelClick">Cancel</button>
                  </div>
                </div>

              </div>
            </template>


            <template is="dom-if" if="[[passResetScreen]]">
              <h1>Password Reset</h1>
              <h3>Which was the email address of your account?</h3>
              <p><i>(we will send a link and get you setup again shortly)</i></p>
              <form action="javascript:;" method="post" class="login-form login__align-center">
                <div class="login__margin ">
                  <label for="email"></label>
                  <input type="password" class="login__input" id="email" name="email" placeholder="Email address..">
                </div>
                <hr class="login__divider-small">
                <div class="login__margin">
                  <button class="btn btn-primary" on-click="onConfirmClick">Send My Link</button>
                </div>
                <div class="login__margin">
                  <button class="btn btn-cancel" on-click="onCancelClick">Cancel</button>
                </div>
              </form>
            </template>

            <template is="dom-if" if="[[passConfirmScreen]]">
              <h1>Password Reset</h1>
              <h3>Your recovery link has been sent.</h3>
              <p><i>(be certain to check your spam or junkmail folder)</i></p>
              <hr class="login__divider-small">
              <div class="login__margin">
                <button class="btn btn-primary">Resend Link</button>
              </div>
              <div class="login__margin">
                <button class="btn btn-cancel" on-click="onCancelClick">Cancel</button>
                <p class="login__margin"><a href="javascript:;" on-click="onNewPassClick">New Password Setup</a>
                </p>
              </div>
            </template>

            <template is="dom-if" if="[[newPassScreen]]">
              <h1>New Password Setup</h1>
              <h3>What would you like your new password to be?</h3>
              <form action="javascript:;" method="post" class="login-form login__align-center">
                <div class="login__margin ">
                  <label for="new-pass"></label>
                  <input type="password" class="login__input" id="new-pass" name="new-pass" placeholder="New Password*"
                         required="">
                </div>
                <div class="login__margin">
                  <label for="confirm-pass"></label>
                  <input type="password" class="login__input" id="confirm-pass" name="confirm-pass"
                         placeholder="Confirm Password*" required="">
                </div>
                <hr class="login__divider-small">
                <div class="login__margin">
                  <button class="btn btn-primary">Save New Password</button>
                </div>
                <div class="login__margin">
                  <button class="btn btn-cancel" on-click="onCancelClick">Cancel</button>
                </div>
              </form>
            </template>

            <template is="dom-if" if="[[securityScreen]]">
              <button class="btn btn--back-dash btn--position" on-click="onBackToPrevClick">
                <iron-icon icon="netlaw-icons:back"></iron-icon>
                Back to Previous
              </button>
              <h1>Login Security Settings</h1>

              <h3>Would you like to change or add login credentials?</h3>

              <p class="login__margin">Username: robkerr2004@hotmail.com</p>
              <p class="login__horizontal"><a href="javascript:;" on-click="onNewPassClick">Change Password</a> | <a
                  href="javascript:;">Remove Login Method</a></p>
              <hr class="login__divider">
              <p class="login__margin">
                <button class="btn btn-yellow" on-click="onAddLoginMethodClick">Add Login Method</button>
              </p>
              <div class="login__margin-top-big">
                <h3>Would you like to add or change a security device?</h3>
                <hr class="login__divider">
                <p class="login__margin">
                  <button class="btn btn-yellow" on-click="onAddSecurityDeviceClick">Add a Security Device</button>
                </p>
                <p class="login__padding">
                  <button class="btn btn-primary" on-click="onContinueClick">Continue</button>
                </p>
              </div>
            </template>

            <template is="dom-if" if="[[secureScreen]]">
              <button class="btn btn--back-dash btn--position" on-click="onBackToSecurityClick">
                <iron-icon icon="netlaw-icons:back"></iron-icon>
                Back to Security Settings
              </button>
              <h1>Secure Your Account</h1>

              <h3>Choose a desired method to enhance your security. </h3>

              <div class="login__row login__margin-top-big">
                <div class="login__item login__item--third">
                  <iron-icon icon="netlaw-icons:secure-mobile"></iron-icon>
                  <p class="login__item-desc login__margin">Generate codes on your smartphone (Android or iPhone).
                    Note: You will be required to download an app. </p>
                  <hr class="login__divider-small">
                  <p class="login__margin">
                    <button class="btn btn-primary" on-click="onMobileClick">Secure with Mobile</button>
                  </p>
                </div>
                <div class="login__item login__item--third">
                  <iron-icon icon="netlaw-icons:secure-sms"></iron-icon>
                  <p class="login__item-desc login__margin">Receieve an SMS message security code on your phone.
                    Note: Any celluar phone will work.</p>
                  <hr class="login__divider-small">
                  <p class="login__margin">
                    <button class="btn btn-primary" on-click="onSmsClick">Secure with SMS</button>
                  </p>
                </div>
                <div class="login__item login__item--third">
                  <iron-icon icon="netlaw-icons:secure-email"></iron-icon>
                  <p class="login__item-desc login__margin">Recieve security codes directly in your preferred
                    email inbox. </p>
                  <hr class="login__divider-small">
                  <p class="login__margin">
                    <button class="btn btn-primary" on-click="onEmailClick">Secure with Email</button>
                  </p>
                </div>
                <div class="login__item login__margin-top-big">
                  <hr class="login__divider">
                  <p class="login__margin">
                    <button class="btn btn--cancel-bordered" on-click="onBackToSecurityClick">Cancel</button>
                  </p>
                </div>
              </div>
            </template>

            <template is="dom-if" if="[[methodScreen]]">
              <h1>Add New Login Method</h1>

              <div class="login-buttons">
                <paper-icon-button icon="netlaw-icons:login-googleplus" name="googleplus"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-facebook" name="facebook"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-linkedin" name="linkedin"
                                   on-click="onLoginClick"></paper-icon-button>
                <paper-icon-button icon="netlaw-icons:login-twitter" name="twitter"
                                   on-click="onLoginClick"></paper-icon-button>
              </div>
              <div class="login__divider-icon">OR</div>

              <div class="login__margin login__align-center">
                <form action="javascript:;" method="post" class="login-form login__align-center">
                  <div class="login__margin ">
                    <label for="login-name2"></label>
                    <input type="text" class="login__input" id="login-name2" name="login" placeholder="Username*"
                           required>
                  </div>
                  <div class="login__margin">
                    <label for="login-pass2"></label>
                    <input type="password" class="login__input" id="login-pass2" name="pass" placeholder="Password*"
                           required>
                  </div>
                  <div class="login__margin-top">
                    <a href="javascript:;" on-click="onForgotClick">Forgot Your Password?</a>
                  </div>
                  <hr class="login__divider-small">
                  <div class="login__margin-bottom">
                    <button class="btn btn-primary" on-click="onLoginClick">Login</button>
                  </div>
                </form>
              </div>
              <p class="login__margin">Donâ€™t have an account? <a href="javascript:;" on-click="onNewPassClick">Request
                One</a>
              </p>
            </template>

            <template is="dom-if" if="[[mobileScreen]]">
              <button class="btn btn--back-dash btn--position" on-click="onBackToSecurityClick">
                <iron-icon icon="netlaw-icons:back"></iron-icon>
                Back to Security Settings
              </button>
              <h1>Secure with Mobile</h1>

              <h3>Scan this code with your mobile authenticator <br>
                and enter the generated code in the box below.</h3>

              <figure class="login__img">
                <img src="/images/QR-code.jpg" alt="QR code">
              </figure>

              <div class="login__padding">
                <button class="btn btn--google-play"></button>
                <button class="btn btn--apple-store"></button>
              </div>

              <form action="javascript:;" method="post" class="login-form login__align-center">
                <div class="login__margin">
                  <label for="securecode"></label>
                  <input type="text" class="login__input" id="securecode" name="securecodecode"
                         placeholder="Security Code*" required>
                </div>
                <hr class="login__divider-small">
                <div class="login__margin-bottom">
                  <button class="btn btn-primary">Atttach Authenticator</button>
                </div>
                <div class="login__margin-bottom">
                  <button class="btn btn--cancel-bordered" on-click="onBackToSecurityClick">Cancel</button>
                </div>
              </form>
            </template>

            <template is="dom-if" if="[[smsScreen]]">
              <button class="btn btn--back-dash btn--position" on-click="onBackToSecurityClick">
                <iron-icon icon="netlaw-icons:back"></iron-icon>
                Back to Security Settings
              </button>
              <h1>Secure with SMS</h1>

              <h3>Type in your phone number, enter the code you <br>
                receive in the section below.</h3>

              <form action="javascript:;" method="post" class="login-form login__align-center">
                <div class="login__margin">
                  <label for="phonenumber"></label>
                  <input type="text" class="login__input" id="phonenumber" name="phonenumber"
                         placeholder="Phone Number*" required>
                </div>
                <hr class="login__divider-small">
                <div class="login__margin-bottom">
                  <button class="btn btn-yellow">Send me a Code</button>
                </div>
              </form>
              <div class="login__padding">
                <hr class="login__divider">
              </div>
              <form action="javascript:;" method="post" class="login-form login-form--mt0 login__align-center">
                <div class="login__margin">
                  <label for="securecode2"></label>
                  <input type="text" class="login__input" id="securecode2" name="securecodecode"
                         placeholder="Security Code*" required>
                </div>
                <hr class="login__divider-small">
                <div class="login__margin-bottom">
                  <button class="btn btn-primary">Atttach</button>
                </div>
                <div class="login__margin-bottom">
                  <button class="btn btn--cancel-bordered" on-click="onBackToSecurityClick">Cancel</button>
                </div>
              </form>
            </template>

            <template is="dom-if" if="[[emailScreen]]">
              <button class="btn btn--back-dash btn--position" on-click="onBackToSecurityClick">
                <iron-icon icon="netlaw-icons:back"></iron-icon>
                Back to Security Settings
              </button>
              <h1>Secure with Email</h1>

              <h3>Type in your email address, enter the code you<br>
                receive in the section below.</h3>

              <form action="javascript:;" method="post" class="login-form login__align-center">
                <div class="login__margin">
                  <label for="phonenumber2"></label>
                  <input type="text" class="login__input" id="phonenumber2" name="phonenumber"
                         placeholder="Phone Number*" required>
                </div>
                <hr class="login__divider-small">
                <div class="login__margin-bottom">
                  <button class="btn btn-yellow">Send me a Code</button>
                </div>
              </form>
              <div class="login__padding">
                <hr class="login__divider">
              </div>
              <form action="javascript:;" method="post" class="login-form login-form--mt0 login__align-center">
                <div class="login__margin">
                  <label for="securecode3"></label>
                  <input type="text" class="login__input" id="securecode3" name="securecodecode"
                         placeholder="Security Code*" required>
                </div>
                <hr class="login__divider-small">
                <div class="login__margin-bottom">
                  <button class="btn btn-primary">Atttach</button>
                </div>
                <div class="login__margin-bottom">
                  <button class="btn btn--cancel-bordered" on-click="onBackToSecurityClick">Cancel</button>
                </div>
              </form>
            </template>

          </div>
        </div>
      </div>
    </app-header-layout>
  </template>
  <script>
      // Your new element extends the Polymer.Element base class
      class NetlawLogin extends Polymer.Element {
          static get is() {
              return 'netlaw-login';
          }

          static get properties() {
              return {
                  firstScreen: {type: Boolean, value: true},
                  passResetScreen: {type: Boolean, value: false},
                  newPassScreen: {type: Boolean, value: false},
                  passConfirmScreen: {type: Boolean, value: false},
                  securityScreen: {type: Boolean, value: false},
                  secureScreen: {type: Boolean, value: false},
                  mobileScreen: {type: Boolean, value: false},
                  smsScreen: {type: Boolean, value: false},
                  emailScreen: {type: Boolean, value: false},
                  methodScreen: {type: Boolean, value: false},
                  createAccountScreen: {type: Boolean, value: false},

                  loading: { type: Boolean, value: false, observer: '_loadingChanged' },
                  selected: { type: String, value: "signin", observer: '_selectedChanged' },

                  identifier: { type: String, value: () => localStorage.getItem("name") || "kyle@draft.netlawplatform.com" },

                  email: String,
                  phone: String,
                  name: String,
                  password: String,
              };
          }

          constructor() {
              super();
          }

          onLoginClick(e) {
              // Direct login on login button click
              this.dispatchEvent(new CustomEvent("logged-in"));

              // Login Security screens
              // this.$.wrapper.classList.add('login--security');
              // this.firstScreen = false;
              // this.methodScreen = false;
              // this.securityScreen = true;
          }

          onCreateAccount(e) {
              this.firstScreen = false;
              this.methodScreen = false;
              this.securityScreen = false;
              this.newPassScreen = false;
              this.emailScreen = false;
              this.createAccountScreen = true;

              this.loading = true;

              api.accounts.createAccount(this.email, this.password, this.name, this.email, this.phone)
                  .success(r => {
                      this.selected = "create-profile";
                      this.accountId = r.user_id;
                      this.accountName = r.name;
                      // this.agreesWithTerms = false;
                      return api.accounts.login(this.email, this.password)
                          .success(r => {
                              api.ticket = r.ticket;
                              this.ticket = r.ticket;
                              this.username = r.username;
                              this.session_id = r.session_id;
                              this.account_id = r.account_id;
                          });
                  })
                  .error(ex => {
                      this.error = ex.message;
                  })
                  .finally(() => this.loading = false);
          }

          onSignIn(e) {
              this.loading = true;
              this.error = null;
              localStorage.setItem("name", this.identifier);

              api.accounts.findAccount(this.identifier)
                  .success(r => {
                      this.selected = "signin-password";
                      //this.identifier = data.identifier;
                      this.userId = r.user_id;
                      this.name = r.name;
                  })
                  .badRequest(ex => { this.error = "Please specify your email or phone"; })
                  .notFound(ex => { this.error = "Couldn't find your NetLaw Account"; })
                  .serverError(ex => { this.error = "Server error please try again."; })
                  //.catch(ex => { this.error = "Request error."; })
                  .finally(() => this.loading = false);
          }

          onSignInNext(e) {
              this.loading = true;
              this.error = null;

              api.accounts.login(this.identifier, this.password, this.name, this.phone)
                  .success(r => {
                      this._setSession(r);
                      return this._fetchProfiles()
                          .then(() => this.password = null);
                  })
                  .notFound(ex => this.error = "Wrong password. Try again or try resetting it.")
                  .finally(() => this.loading = false);
          }

          onBackToPrevClick(e) {
              this.$.wrapper.classList.remove('login--security');
              this.securityScreen = false;
              this.firstScreen = true;
              this.createAccountScreen = false;
          }

          onBackToSecurityClick(e) {
              e.preventDefault();
              this.secureScreen = false;
              this.mobileScreen = false;
              this.smsScreen = false;
              this.emailScreen = false;
              this.securityScreen = true;
          }

          onMobileClick(e) {
              this.secureScreen = false;
              this.mobileScreen = true;
          }

          onSmsClick(e) {
              this.secureScreen = false;
              this.smsScreen = true;
          }

          onEmailClick(e) {
              this.secureScreen = false;
              this.emailScreen = true;
          }

          onAddSecurityDeviceClick(e) {

              this.securityScreen = false;
              this.secureScreen = true;
          }

          onAddLoginMethodClick(e) {
              this.$.wrapper.classList.remove('login--securityScreen');
              this.securityScreen = false;
              this.methodScreen = true;
          }

          onContinueClick(e) {
              this.dispatchEvent(new CustomEvent("logged-in"));
          }

          onForgotClick(e) {
              e.preventDefault();
              this.firstScreen = false;
              this.methodScreen = false;
              this.passResetScreen = true;
          }

          onNewPassClick(e) {
              e.preventDefault();
              this.firstScreen = false;
              this.methodScreen = false;
              this.securityScreen = false;
              this.passConfirmScreen = false;
              this.newPassScreen = true;
          }

          onConfirmClick(e) {
              e.preventDefault();
              this.passResetScreen = false;
              this.passConfirmScreen = true;
          }

          onCancelClick(e) {
              e.preventDefault();
              this.passResetScreen = false;
              this.newPassScreen = false;
              this.passConfirmScreen = false;
              this.createAccountScreen = false;
              this.firstScreen = true;
          }

          _loadingChanged(value) {
              if (value) return; //focus when done loading
              let elements = Array.from(Polymer.dom(this.root).querySelectorAll("[autofocus]")).filter(e => e.offsetParent);
              if (elements.length) elements[0].focus();
          }

          _selectedChanged(value) {
              this.error = null;
              this.loading = false;
              let elements = Array.from(Polymer.dom(this.root).querySelectorAll("[autofocus]")).filter(e => e.offsetParent);
              if (elements.length) elements[0].focus();
          }

      }

      //Now, register your new custom element so the browser can use it
      customElements.define(NetlawLogin.is, NetlawLogin);
  </script>
</dom-module>